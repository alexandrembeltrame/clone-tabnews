#!/bin/sh
echo "üîç Verificando dados sens√≠veis..."

# Extens√µes de arquivos que NUNCA devem ser commitados
BLOCKED_EXTENSIONS="\.pem$|\.key$|\.p12$|\.pfx$|\.jks$|\.keystore$|\.cer$|\.crt$|\.der$"

# Nomes de arquivos sens√≠veis (regex)
BLOCKED_FILENAMES="^\.env$|^\.env\.local$|^\.env\.production$|credentials|secret|private.*key|id_rsa|id_dsa"

# Lista de padr√µes para detectar dados sens√≠veis no CONTE√öDO
PATTERNS=(
  # Chaves de API e Tokens (qualquer vari√°vel com key/token/secret)
  "['\"]?[A-Z_]*[Kk][Ee][Yy]['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
  "['\"]?[A-Z_]*[Tt][Oo][Kk][Ee][Nn]['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
  "['\"]?[A-Z_]*[Ss][Ee][Cc][Rr][Ee][Tt]['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{16,}['\"]"
  
  # AWS
  "AKIA[0-9A-Z]{16}"
  "aws[_-]?access[_-]?key[_-]?id['\"]?\s*[:=]\s*['\"][A-Z0-9]{20}['\"]"
  "aws[_-]?secret[_-]?access[_-]?key['\"]?\s*[:=]\s*['\"][A-Za-z0-9/+=]{40}['\"]"
  
  # Senhas (qualquer vari√°vel com password/passwd/pwd)
  "['\"]?[A-Z_]*[Pp][Aa][Ss][Ss][Ww][Oo][Rr][Dd]['\"]?\s*[:=]\s*['\"][^'\"]{6,}['\"]"
  "['\"]?[A-Z_]*[Pp][Aa][Ss][Ss][Ww][Dd]['\"]?\s*[:=]\s*['\"][^'\"]{6,}['\"]"
  
  # Database URLs com credenciais
  "mongodb(\+srv)?://[^:]+:[^@]+@"
  "postgresql://[^:]+:[^@]+@"
  "mysql://[^:]+:[^@]+@"
  "postgres://[^:]+:[^@]+@"
  
  # Private Keys
  "-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
  
  # JWT Tokens (formato completo)
  "eyJ[a-zA-Z0-9_-]{10,}\.eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}"
  
  # GitHub Tokens
  "gh[pousr]_[0-9a-zA-Z]{36}"
  "github_pat_[0-9a-zA-Z_]{82}"
  
  # Slack Tokens
  "xox[baprs]-[0-9a-zA-Z-]+"
  
  # Google API
  "AIza[0-9A-Za-z_-]{35}"
  
  # Stripe
  "sk_live_[0-9a-zA-Z]{24,}"
  "pk_live_[0-9a-zA-Z]{24,}"
  
  # Heroku
  "heroku[_-]?api[_-]?key['\"]?\s*[:=]\s*['\"][0-9a-f-]{36}['\"]"
  
  # Tokens gen√©ricos (32+ caracteres alfanum√©ricos)
  "['\"][a-zA-Z0-9_\-]{32,}['\"]"
)

# Arquivos/pastas a serem ignorados na verifica√ß√£o de conte√∫do
IGNORED_PATTERNS=".env.example|.env.sample|.env.template|.husky|node_modules|package-lock.json|yarn.lock|pnpm-lock.yaml"

# Obter arquivos staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ Nenhum arquivo para verificar"
  exit 0
fi

FOUND_SENSITIVE=0

# 1. Verificar extens√µes de arquivo bloqueadas
echo "Verificando extens√µes de arquivo..."
for file in $STAGED_FILES; do
  if echo "$file" | grep -qiE "$BLOCKED_EXTENSIONS"; then
    echo "‚ùå ERRO: Arquivo com extens√£o sens√≠vel detectado: $file"
    echo "   Extens√µes de certificados/chaves privadas n√£o devem ser commitadas"
    FOUND_SENSITIVE=1
  fi
done

# 2. Verificar nomes de arquivos sens√≠veis
echo "Verificando nomes de arquivo..."
for file in $STAGED_FILES; do
  filename=$(basename "$file")
  if echo "$filename" | grep -qiE "$BLOCKED_FILENAMES"; then
    if echo "$file" | grep -qvE "$IGNORED_PATTERNS"; then
      echo "‚ùå ERRO: Arquivo sens√≠vel detectado: $file"
      echo "   Este tipo de arquivo n√£o deve ser commitado"
      FOUND_SENSITIVE=1
    fi
  fi
done

# 3. Verificar conte√∫do dos arquivos
echo "Verificando conte√∫do dos arquivos..."
for file in $STAGED_FILES; do
  # Ignorar arquivos bin√°rios e arquivos da lista de ignorados
  if [ -f "$file" ] && file "$file" | grep -q text && ! echo "$file" | grep -qE "$IGNORED_PATTERNS"; then
    for pattern in "${PATTERNS[@]}"; do
      if grep -qE "$pattern" "$file" 2>/dev/null; then
        echo "‚ùå AVISO: Poss√≠vel dado sens√≠vel detectado em: $file"
        FOUND_SENSITIVE=1
        break
      fi
    done
  fi
done

if [ $FOUND_SENSITIVE -eq 1 ]; then
  echo ""
  echo "‚õî COMMIT BLOQUEADO!"
  echo "   Dados sens√≠veis foram detectados."
  echo ""
  echo "üí° Dicas:"
  echo "   - Use vari√°veis de ambiente (.env) para dados sens√≠veis"
  echo "   - Adicione arquivos sens√≠veis ao .gitignore"
  echo "   - Nunca commite chaves, senhas ou tokens no c√≥digo"
  echo "   - Use .env.example com valores fake para documenta√ß√£o"
  exit 1
fi

echo "‚úÖ Nenhum dado sens√≠vel detectado"
exit 0
